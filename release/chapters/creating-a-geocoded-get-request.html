<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="thoughtbot" />
  <meta name="author" content="Jessie Young" />
  <meta name="author" content="Diana Zmuda" />
  <title>iOS on Rails (Beta): Creating a geocoded GET request</title>
  <style type="text/css"><![CDATA[code{white-space: pre;}]]></style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="data:text/css,%2A%20%7B%0A%20%20%2Dmoz%2Dbox%2Dsizing%3A%20border%2Dbox%3B%0A%20%20%2Dwebkit%2Dbox%2Dsizing%3A%20border%2Dbox%3B%0A%20%20box%2Dsizing%3A%20border%2Dbox%3B%20%7D%0A%0Abody%20%7B%0A%20%20font%2Dsize%3A%201em%3B%0A%20%20height%3A%20100%25%3B%0A%20%20margin%3A%200%20auto%3B%0A%20%20max%2Dwidth%3A%2054em%3B%0A%20%20padding%3A%200%201em%204%2E5em%3B%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20600px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%204em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20700px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20font%2Dsize%3A%201%2E125em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20800px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%206em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20880px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%208em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20940px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%2010em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%201800px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20font%2Dsize%3A%201%2E375em%3B%20%7D%20%7D%0A%0Anav%20%7B%0A%20%20border%2Dbottom%3A%201px%20dashed%20%23dddddd%3B%0A%20%20border%2Dtop%3A%201px%20dashed%20%23dddddd%3B%0A%20%20padding%3A%201%2E5em%200%3B%0A%20%20margin%3A%201%2E5em%200%3B%20%7D%0A%20%20nav%20%3E%20ul%20%3E%20li%20%3E%20a%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%20%7D%0A%0Aheader%20%7B%0A%20%20padding%3A%204%2E5em%200%3B%20%7D%0A%0Abody%20%7B%0A%20%20%2Dwebkit%2Dfont%2Dsmoothing%3A%20antialiased%3B%0A%20%20color%3A%20%23444444%3B%0A%20%20font%2Dfamily%3A%20%22proxima%2Dnova%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0A%20%20line%2Dheight%3A%201%2E5em%3B%20%7D%0A%0Ah1%2C%20h2%2C%20h3%2C%20h4%2C%20h5%2C%20h6%20%7B%0A%20%20color%3A%20%23222222%3B%0A%20%20font%2Dfamily%3A%20%22proxima%2Dnova%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0A%20%20line%2Dheight%3A%201%2E25em%3B%0A%20%20margin%3A%201%2E5em%200%200%2E375em%3B%0A%20%20text%2Drendering%3A%20optimizeLegibility%3B%20%7D%0A%20%20h1%20%3E%20a%2C%20h2%20%3E%20a%2C%20h3%20%3E%20a%2C%20h4%20%3E%20a%2C%20h5%20%3E%20a%2C%20h6%20%3E%20a%20%7B%0A%20%20%20%20color%3A%20%23222222%3B%20%7D%0A%0Ah1%20%7B%0A%20%20margin%3A%203em%200%200%2E375em%3B%0A%20%20font%2Dsize%3A%201%2E75em%3B%20%7D%0A%20%20h1%20%3E%20a%20%7B%0A%20%20%20%20color%3A%20%23c32f34%3B%20%7D%0A%20%20%20%20h1%20%3E%20a%3Ahover%2C%20h1%20%3E%20a%3Afocus%20%7B%0A%20%20%20%20%20%20color%3A%20%23222222%3B%20%7D%0A%20%20h1%2Etitle%20%7B%0A%20%20%20%20font%2Dsize%3A%203em%3B%0A%20%20%20%20font%2Dweight%3A%20900%3B%0A%20%20%20%20line%2Dheight%3A%201%3B%0A%20%20%20%20margin%3A%200%200%20%2E125em%3B%20%7D%0A%20%20%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20600px%29%20%7B%0A%20%20%20%20%20%20h1%2Etitle%20%7B%0A%20%20%20%20%20%20%20%20font%2Dsize%3A%204em%3B%20%7D%20%7D%0A%0Ah2%20%7B%0A%20%20font%2Dsize%3A%201em%3B%0A%20%20letter%2Dspacing%3A%201px%3B%0A%20%20text%2Dtransform%3A%20uppercase%3B%20%7D%0A%20%20h2%2Eauthor%20%7B%0A%20%20%20%20color%3A%20%23999999%3B%0A%20%20%20%20float%3A%20left%3B%0A%20%20%20%20font%2Dsize%3A%201em%3B%0A%20%20%20%20font%2Dweight%3A%20200%3B%0A%20%20%20%20margin%3A%200%3B%0A%20%20%20%20text%2Dtransform%3A%20none%3B%20%7D%0A%20%20%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20600px%29%20%7B%0A%20%20%20%20%20%20h2%2Eauthor%20%7B%0A%20%20%20%20%20%20%20%20font%2Dsize%3A%201%2E25em%3B%20%7D%20%7D%0A%20%20%20%20h2%2Eauthor%3Anot%28%3Alast%2Dchild%29%20%7B%0A%20%20%20%20%20%20margin%2Dright%3A%201em%3B%20%7D%0A%0Ah3%20%7B%0A%20%20font%2Dsize%3A%201em%3B%20%7D%0A%0Ah4%20%7B%0A%20%20font%2Dsize%3A%201%2E5em%3B%20%7D%0A%0Ah5%20%7B%0A%20%20font%2Dsize%3A%201%2E25em%3B%20%7D%0A%0Ah6%20%7B%0A%20%20font%2Dsize%3A%201em%3B%20%7D%0A%0Ap%20%7B%0A%20%20margin%3A%200%200%200%2E75em%3B%20%7D%0A%0Aa%20%7B%0A%20%20%2Dmoz%2Dtransition%3A%20all%200%2E15s%20ease%2Dout%200%3B%0A%20%20%2Dwebkit%2Dtransition%3A%20all%200%2E15s%20ease%2Dout%200%3B%0A%20%20color%3A%20%23477dca%3B%0A%20%20text%2Ddecoration%3A%20none%3B%0A%20%20transition%3A%20all%200%2E15s%20ease%2Dout%200%3B%20%7D%0A%20%20a%3Ahover%20%7B%0A%20%20%20%20color%3A%20%232c5999%3B%20%7D%0A%20%20a%3Aactive%2C%20a%3Afocus%20%7B%0A%20%20%20%20color%3A%20%232c5999%3B%0A%20%20%20%20outline%3A%20none%3B%20%7D%0A%0Ahr%20%7B%0A%20%20border%3A%20none%3B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23dddddd%3B%0A%20%20margin%3A%201%2E5em%200%3B%20%7D%0A%0Aimg%20%7B%0A%20%20margin%3A%200%3B%0A%20%20max%2Dwidth%3A%20100%25%3B%20%7D%0A%0Acode%20%7B%0A%20%20font%2Dfamily%3A%20inconsolata%2C%20%22Bitstream%20Vera%20Sans%20Mono%22%2C%20Consolas%2C%20Courier%2C%20monospace%3B%0A%20%20font%2Dsize%3A%20%2E875em%3B%0A%20%20white%2Dspace%3A%20pre%3B%0A%20%20word%2Dwrap%3A%20break%2Dword%3B%20%7D%0A%0Apre%20%7B%0A%20%20background%3A%20%23f7f7f7%3B%0A%20%20border%3A%201px%20solid%20%23dddddd%3B%0A%20%20line%2Dheight%3A%201%2E35%3B%0A%20%20overflow%2Dx%3A%20scroll%3B%0A%20%20padding%3A%20%2E5rem%201rem%3B%0A%20%20white%2Dspace%3A%20pre%3B%0A%20%20word%2Dwrap%3A%20normal%3B%20%7D%0A%20%20pre%20code%20%7B%0A%20%20%20%20word%2Dwrap%3A%20normal%3B%20%7D%0A%0Ablockquote%20%7B%0A%20%20border%2Dleft%3A%202px%20solid%20%23dddddd%3B%0A%20%20color%3A%20%236a6a6a%3B%0A%20%20margin%3A%201%2E5em%200%3B%0A%20%20padding%2Dleft%3A%200%2E75em%3B%20%7D%0A" rel="stylesheet" />
  <script type="text/javascript"><![CDATA[
    (function() {
      var config = {
        kitId: 'bgd6ksj',
        scriptTimeout: 3000
      };
      var h=document.getElementsByTagName("html")[0];h.className+=" wf-loading";var t=setTimeout(function(){h.className=h.className.replace(/(\s|^)wf-loading(\s|$)/g," ");h.className+=" wf-inactive"},config.scriptTimeout);var tk=document.createElement("script"),d=false;tk.src='//use.typekit.net/'+config.kitId+'.js';tk.type="text/javascript";tk.async="true";tk.onload=tk.onreadystatechange=function(){var a=this.readyState;if(d||a&&a!="complete"&&a!="loaded")return;d=true;clearTimeout(t);try{Typekit.load(config)}catch(b){}};var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(tk,s)
    })();
  ]]></script>
</head>
<body><section id="creating-a-geocoded-get-request" class="level1">
<h1>Creating a geocoded GET request</h1>
<section id="what-is-geocoding" class="level3">
<h3>What is geocoding?</h3>
<blockquote>
<p>Geocoding is the process of finding associated geographic coordinates (often expressed as latitude and longitude) from other geographic data, such as street addresses, or ZIP codes.</p>
</blockquote>
<p>-- <a href="http://en.wikipedia.org/wiki/Geocoding">Wikipedia</a>.</p>
<p>Geocoding gives us the power to take location information from humans and turn it into something that a computer can understand and reason about.</p>
<p><a href="http://www.yelp.com">Yelp</a>, for example, does not ask businesses to add their latitude and longitude when creating a profile. Instead, they ask for the street address and zipcode, which the Yelp application transforms into a latitude and longitude that can be plotted on a map.</p>
<p>This is important because humans don't think in the decimal precision terms of latitude and longitude, but computers do. A web application that receives location information from humans will always receive a string of text, and that application cannot plot locations on a map or compute distances between points without turning that text into a set of coordinates.</p>
<p>There are many approaches to geocoding with Rails. If you're interested in learning more, thoughbot's <a href="https://learn.thoughtbot.com/products/22-geocoding-on-rails"><em>Geocoding on Rails</em></a> provides a thorough analysis and discussion of the various options.</p>
</section>
<section id="geocoding-in-humon-choosing-a-library" class="level3">
<h3>Geocoding in Humon: choosing a library</h3>
<p>For Humon, we aren't going to be transforming one type of geographic data to another. What we want is to be able to receive a latitude and longitude from the iOS application and return the closest events to those coordinates.</p>
<p>After consulting <em>Geocoding on Rails</em>, we chose the <a href="https://github.com/alexreisner/geocoder">Geocoder</a> gem for Humon. It supports distance queries, is simple to use, and is under active development.</p>
</section>
<section id="it-all-starts-with-a-request-spec-3" class="level3">
<h3>It all starts with a request spec</h3>
<p>Before we jump into setting up our <code>Event</code> model with the Geocoder gem, let's write a request spec for this new endpoint. Since this new endpoint will require a controller of its own, we will create an <code>events</code> directory within <code>spec/requests</code> and include this spec there:</p>
<pre><code># spec/requests/api/v2/events/nearest_spec.rb

describe 'GET /v1/events/nearests?lat=&amp;lon=&amp;radius=' do
  it 'returns the events closest to the lat and lon' do
    near_event = create(:event, lat: 37.760322, lon: -122.429667)
    farther_event = create(:event, lat: 37.760321, lon: -122.429667)
    create(:event, lat: 37.687737, lon: -122.470608)
    lat = 37.771098
    lon = -122.430782
    radius = 5

    get "/v1/events/nearests?lat=#{lat}&amp;lon=#{lon}&amp;radius=#{radius}"

    expect(response_json).to eq([
      {
        'address' =&gt; near_event.address,
        'ended_at' =&gt; near_event.ended_at,
        'id' =&gt; near_event.id,
        'lat' =&gt; near_event.lat,
        'lon' =&gt; near_event.lon,
        'name' =&gt; near_event.name,
        'owner' =&gt; { 'device_token' =&gt; near_event.owner.device_token },
        'started_at' =&gt; near_event.started_at.as_json,
      },
      {
        'address' =&gt; farther_event.address,
        'ended_at' =&gt; farther_event.ended_at,
        'id' =&gt; farther_event.id,
        'lat' =&gt; farther_event.lat,
        'lon' =&gt; farther_event.lon,
        'name' =&gt; farther_event.name,
        'owner' =&gt; { 'device_token' =&gt; farther_event.owner.device_token },
        'started_at' =&gt; farther_event.started_at.as_json,
      }
    ])
  end
end</code></pre>
</section>
<section id="controller-4" class="level3">
<h3>Controller</h3>
<p>When we run the test above, we get an interesting error:</p>
<pre><code>ActiveRecord::RecordNotFound:
   Couldn't find Event with id=nearests</code></pre>
<p>What's that about!? If we run <code>rake routes</code> in our shell we'll see that our app has the following GET endpoint defined:</p>
<pre><code>GET   /v1/events/:id(.:format)  api/v1/events#show</code></pre>
<p>Rails is matching <code>get '/v1/events/nearests'</code> to this pattern and thinks we are looking for an <code>event</code> with an <code>id</code> of <code>nearests</code>. How do we fix this? We need to tell our Rails app that a GET request at <code>events/nearests</code> is different from a GET request at <code>events/:id</code>:</p>
<pre><code># config/routes.rb

Humon::Application.routes.draw do
  scope module: :api, defaults: { format: 'json' } do
   namespace :v1 do
      namespace :events do
        resources :nearests, only: [:index]
      end

  ...

    end
  end
end</code></pre>
<p>If we run <code>rake routes</code> in the shell again, we'll see that there's a new GET endpoint:</p>
<pre><code>GET   /v1/events/nearests(.:format) api/v1/events/nearests#index</code></pre>
<p>And when we run our test again, our error has changed:</p>
<pre><code>ActionController::RoutingError:
   uninitialized constant Api::V1::Events::NearestsController</code></pre>
<p>Nice! Time to define that controller. In the <a href="https://github.com/thoughtbot/ios-on-rails/blob/master/example_apps/rails/app/controllers/api/v1/events/nearests_controller.rb"><code>NearestsController</code></a>, we will be using the <a href="https://github.com/alexreisner/geocoderlocation-aware-database-queries.html"><code>near</code> scope</a> (given to us by the Geocoder gem) which takes in a latitude-longitude pair, radius, and units as arguments:</p>
<pre><code># app/controllers/api/1/events/nearests_controller.rb

class Api::V1::Events::NearestsController &lt; ApiController
  def index
    @events = Event.near(
      [params[:lat], params[:lon]],
      params[:radius],
      units: :km
    )
  end
end</code></pre>
<p>Run the test again, and again, our test is failing:</p>
<pre><code> NoMethodError:
   undefined method `near' for #&lt;Class:0x007ffba8583468&gt;</code></pre>
<p>Oh yeah! We forgot to actually add the Geocoder gem. Let's do that now.</p>
</section>
<section id="model-and-gemfile" class="level3">
<h3>Model (and Gemfile)</h3>
<p>Let's start by adding <code>gem 'geocoder'</code> to our <a href="https://github.com/thoughtbot/ios-on-rails/blob/master/example_apps/rails/Gemfile">Gemfile</a> and running <code>bundle install</code>.</p>
<p>We already have the <code>lat</code> and <code>lon</code> attributes on our <code>Event</code> model, so no need for a database migration. If we run our test again, however, we will get the same <code>undefined method</code> error that we got before.</p>
<p>According to the <a href="https://github.com/alexreisner/geocoderobject-geocoding.html">Geocoder README</a>, "your model must tell Geocoder which method returns your object's geocodable address". Since our model is <em>already</em> geocoded (meaning: it already has the latitude and longitude set) we need to tell Geocoder which attributes store latitude and longitude:</p>
<pre><code># app/models/event.rb

class Event &lt; ActiveRecord::Base

  ...

  reverse_geocoded_by :lat, :lon

end</code></pre>
<p>This setup is a bit confusing. If we were <em>reverse geocoding</em>, we would be looking at the latitude and longitude in order to find an address. On the other hand, if we were <em>geocoding</em>, we would be turning an address string into a set of coordinates.</p>
<p>In Humon we're neither geocoding nor reverse geocoding. We're using geolocation information to find objects that are close to each other using Geocoder's <code>near</code> scope. By adding the line above to our <code>Event</code> model, we are telling Geocoder that this is a geocoded model and that the geocoded coordinates are named <code>lat</code> and <code>lon</code>.</p>
<p>An illustrative example: comment out the new line in our <code>Event</code> model above and open a Rails console. Create or select an <code>event</code>:</p>
<pre><code>irb(main):001:0&gt; event = Event.first

irb(main):002:0&gt; event.geocoded?

NoMethodError: undefined method `geocoded?' for #&lt;Event:0x007fdb4e4353b0&gt;</code></pre>
<p>Does this error message look familiar? Answer: yes! This is the same type of error we got when we last ran our test.</p>
<p>Let's exit our Rails console, add <code>reverse_geocoded_by :lat, :lon</code> back to the <code>Event</code> model, and then open a new Rails console and do the same thing:</p>
<pre><code>irb(main):001:0&gt; event = Event.first

irb(main):002:0&gt; event.geocoded?

=&gt; true</code></pre>
<p>By adding <code>reverse_geocoded_by</code>, we are telling Geocoder that this is a geocoded object, and consequently giving our <code>Event</code> model access to Geocoder's instance methods, such as <code>geocoded?</code>, and scopes, such as <code>near</code>.</p>
</section>
<section id="view-3" class="level3">
<h3>View</h3>
<p>Run the test again, and our failure has changed.</p>
<pre><code>  Failure/Error: get "/v1/events/nearests?lat=#{lat}&amp;lon=#{lon}&amp;radius=#{radius}"
  ActionView::MissingTemplate api/v1/events/nearests/index</code></pre>
<p>We now need to create a <code>nearests</code> directory within <code>app/views/api/v1/events</code> and create the following template inside of that directory:</p>
<pre><code># app/views/api/v1/events/nearests/index.json.jbuilder

json.partial! 'api/v1/events/event', collection: @events, as: :event</code></pre>
<p>This view is using the <code>_event.json.jbuilder</code> template we already have, and rendering the <code>@events</code> found in the controller.</p>
<p>When we run our test again, and it passes! Time to address the sad path...</p>
</section>
<section id="it-all-starts-with-a-request-spec-part-ii-2" class="level3">
<h3>It all starts with a request spec, part II</h3>
<p>We want to explicitly define what happens when there are no events nearby. Let's do that through writing a test first:</p>
<pre><code># spec/requests/api/v1/events/nearest_spec.rb

describe 'GET /v1/events/nearest?lat=&amp;lon=&amp;radius=' do

 ...

  it 'returns an error message when no event found' do
    lat = 37.771098
    lon = -122.430782
    radius = 1

    get "/v1/events/nearest?lat=#{lat}&amp;lon=#{lon}&amp;radius=#{radius}"

    expect(response_json).to eq({ 'message' =&gt; 'No Events Found' })
    expect(response.code.to_i).to eq 200
  end
end</code></pre>
<p>When we run this test, we get the following error:</p>
<pre><code> expected: {"message"=&gt;"No Events Found"}
       got: []</code></pre>
</section>
<section id="controller-5" class="level3">
<h3>Controller</h3>
<p>Time to add some branching in our controller so that we're returning the correct message.</p>
<pre><code># app/controllers/api/v1/events/nearests_controller.rb

class Api::V1::Events::NearestsController &lt; ApiController
  def show

  ...

    if @events.any?
      render
    else
      render json: { message: 'No Events Found' }, status: 200
    end
  end
end</code></pre>
<p>And just like that, our test is now passing.</p>
<p></p>
</section>
</section></body>
</html>
