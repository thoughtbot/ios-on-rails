<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="thoughtbot" />
  <meta name="author" content="Jessie Young" />
  <meta name="author" content="Diana Zmuda" />
  <title>iOS on Rails (Beta): Creating a PATCH request</title>
  <style type="text/css"><![CDATA[code{white-space: pre;}]]></style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="data:text/css,%2A%20%7B%0A%20%20%2Dmoz%2Dbox%2Dsizing%3A%20border%2Dbox%3B%0A%20%20%2Dwebkit%2Dbox%2Dsizing%3A%20border%2Dbox%3B%0A%20%20box%2Dsizing%3A%20border%2Dbox%3B%20%7D%0A%0Abody%20%7B%0A%20%20font%2Dsize%3A%201em%3B%0A%20%20height%3A%20100%25%3B%0A%20%20margin%3A%200%20auto%3B%0A%20%20max%2Dwidth%3A%2054em%3B%0A%20%20padding%3A%200%201em%204%2E5em%3B%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20600px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%204em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20700px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20font%2Dsize%3A%201%2E125em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20800px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%206em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20880px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%208em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20940px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%2010em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%201800px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20font%2Dsize%3A%201%2E375em%3B%20%7D%20%7D%0A%0Anav%20%7B%0A%20%20border%2Dbottom%3A%201px%20dashed%20%23dddddd%3B%0A%20%20border%2Dtop%3A%201px%20dashed%20%23dddddd%3B%0A%20%20padding%3A%201%2E5em%200%3B%0A%20%20margin%3A%201%2E5em%200%3B%20%7D%0A%20%20nav%20%3E%20ul%20%3E%20li%20%3E%20a%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%20%7D%0A%0Aheader%20%7B%0A%20%20padding%3A%204%2E5em%200%3B%20%7D%0A%0Abody%20%7B%0A%20%20%2Dwebkit%2Dfont%2Dsmoothing%3A%20antialiased%3B%0A%20%20color%3A%20%23444444%3B%0A%20%20font%2Dfamily%3A%20%22proxima%2Dnova%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0A%20%20line%2Dheight%3A%201%2E5em%3B%20%7D%0A%0Ah1%2C%20h2%2C%20h3%2C%20h4%2C%20h5%2C%20h6%20%7B%0A%20%20color%3A%20%23222222%3B%0A%20%20font%2Dfamily%3A%20%22proxima%2Dnova%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0A%20%20line%2Dheight%3A%201%2E25em%3B%0A%20%20margin%3A%201%2E5em%200%200%2E375em%3B%0A%20%20text%2Drendering%3A%20optimizeLegibility%3B%20%7D%0A%20%20h1%20%3E%20a%2C%20h2%20%3E%20a%2C%20h3%20%3E%20a%2C%20h4%20%3E%20a%2C%20h5%20%3E%20a%2C%20h6%20%3E%20a%20%7B%0A%20%20%20%20color%3A%20%23222222%3B%20%7D%0A%0Ah1%20%7B%0A%20%20margin%3A%203em%200%200%2E375em%3B%0A%20%20font%2Dsize%3A%201%2E75em%3B%20%7D%0A%20%20h1%20%3E%20a%20%7B%0A%20%20%20%20color%3A%20%23c32f34%3B%20%7D%0A%20%20%20%20h1%20%3E%20a%3Ahover%2C%20h1%20%3E%20a%3Afocus%20%7B%0A%20%20%20%20%20%20color%3A%20%23222222%3B%20%7D%0A%20%20h1%2Etitle%20%7B%0A%20%20%20%20font%2Dsize%3A%203em%3B%0A%20%20%20%20font%2Dweight%3A%20900%3B%0A%20%20%20%20line%2Dheight%3A%201%3B%0A%20%20%20%20margin%3A%200%200%20%2E125em%3B%20%7D%0A%20%20%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20600px%29%20%7B%0A%20%20%20%20%20%20h1%2Etitle%20%7B%0A%20%20%20%20%20%20%20%20font%2Dsize%3A%204em%3B%20%7D%20%7D%0A%0Ah2%20%7B%0A%20%20font%2Dsize%3A%201em%3B%0A%20%20letter%2Dspacing%3A%201px%3B%0A%20%20text%2Dtransform%3A%20uppercase%3B%20%7D%0A%20%20h2%2Eauthor%20%7B%0A%20%20%20%20color%3A%20%23999999%3B%0A%20%20%20%20float%3A%20left%3B%0A%20%20%20%20font%2Dsize%3A%201em%3B%0A%20%20%20%20font%2Dweight%3A%20200%3B%0A%20%20%20%20margin%3A%200%3B%0A%20%20%20%20text%2Dtransform%3A%20none%3B%20%7D%0A%20%20%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20600px%29%20%7B%0A%20%20%20%20%20%20h2%2Eauthor%20%7B%0A%20%20%20%20%20%20%20%20font%2Dsize%3A%201%2E25em%3B%20%7D%20%7D%0A%20%20%20%20h2%2Eauthor%3Anot%28%3Alast%2Dchild%29%20%7B%0A%20%20%20%20%20%20margin%2Dright%3A%201em%3B%20%7D%0A%0Ah3%20%7B%0A%20%20font%2Dsize%3A%201em%3B%20%7D%0A%0Ah4%20%7B%0A%20%20font%2Dsize%3A%201%2E5em%3B%20%7D%0A%0Ah5%20%7B%0A%20%20font%2Dsize%3A%201%2E25em%3B%20%7D%0A%0Ah6%20%7B%0A%20%20font%2Dsize%3A%201em%3B%20%7D%0A%0Ap%20%7B%0A%20%20margin%3A%200%200%200%2E75em%3B%20%7D%0A%0Aa%20%7B%0A%20%20%2Dmoz%2Dtransition%3A%20all%200%2E15s%20ease%2Dout%200%3B%0A%20%20%2Dwebkit%2Dtransition%3A%20all%200%2E15s%20ease%2Dout%200%3B%0A%20%20color%3A%20%23477dca%3B%0A%20%20text%2Ddecoration%3A%20none%3B%0A%20%20transition%3A%20all%200%2E15s%20ease%2Dout%200%3B%20%7D%0A%20%20a%3Ahover%20%7B%0A%20%20%20%20color%3A%20%232c5999%3B%20%7D%0A%20%20a%3Aactive%2C%20a%3Afocus%20%7B%0A%20%20%20%20color%3A%20%232c5999%3B%0A%20%20%20%20outline%3A%20none%3B%20%7D%0A%0Ahr%20%7B%0A%20%20border%3A%20none%3B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23dddddd%3B%0A%20%20margin%3A%201%2E5em%200%3B%20%7D%0A%0Aimg%20%7B%0A%20%20margin%3A%200%3B%0A%20%20max%2Dwidth%3A%20100%25%3B%20%7D%0A%0Acode%20%7B%0A%20%20font%2Dfamily%3A%20inconsolata%2C%20%22Bitstream%20Vera%20Sans%20Mono%22%2C%20Consolas%2C%20Courier%2C%20monospace%3B%0A%20%20font%2Dsize%3A%20%2E875em%3B%0A%20%20white%2Dspace%3A%20pre%3B%0A%20%20word%2Dwrap%3A%20break%2Dword%3B%20%7D%0A%0Apre%20%7B%0A%20%20background%3A%20%23f7f7f7%3B%0A%20%20border%3A%201px%20solid%20%23dddddd%3B%0A%20%20line%2Dheight%3A%201%2E35%3B%0A%20%20overflow%2Dx%3A%20scroll%3B%0A%20%20padding%3A%20%2E5rem%201rem%3B%0A%20%20white%2Dspace%3A%20pre%3B%0A%20%20word%2Dwrap%3A%20normal%3B%20%7D%0A%20%20pre%20code%20%7B%0A%20%20%20%20word%2Dwrap%3A%20normal%3B%20%7D%0A%0Ablockquote%20%7B%0A%20%20border%2Dleft%3A%202px%20solid%20%23dddddd%3B%0A%20%20color%3A%20%236a6a6a%3B%0A%20%20margin%3A%201%2E5em%200%3B%0A%20%20padding%2Dleft%3A%200%2E75em%3B%20%7D%0A" rel="stylesheet" />
  <script type="text/javascript"><![CDATA[
    (function() {
      var config = {
        kitId: 'bgd6ksj',
        scriptTimeout: 3000
      };
      var h=document.getElementsByTagName("html")[0];h.className+=" wf-loading";var t=setTimeout(function(){h.className=h.className.replace(/(\s|^)wf-loading(\s|$)/g," ");h.className+=" wf-inactive"},config.scriptTimeout);var tk=document.createElement("script"),d=false;tk.src='//use.typekit.net/'+config.kitId+'.js';tk.type="text/javascript";tk.async="true";tk.onload=tk.onreadystatechange=function(){var a=this.readyState;if(d||a&&a!="complete"&&a!="loaded")return;d=true;clearTimeout(t);try{Typekit.load(config)}catch(b){}};var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(tk,s)
    })();
  ]]></script>
</head>
<body><section id="creating-a-patch-request" class="level1">
<h1>Creating a PATCH request</h1>
<section id="it-all-starts-with-a-request-spec-2" class="level3">
<h3>It all starts with a request spec</h3>
<p>We will start working on our PATCH request the same way we began working on our other requests: with a request spec. In this test, we want to create an <code>event</code> with the name <code>'Old Name'</code> and send a PATCH request to change the name to <code>'New Name'</code>.</p>
<p>In our test setup, we will create the first event with <code>FactoryGirl</code> and then use the PATCH request with a new event name in the parameters as the spec exercise. Our expectation looks at the name of the <code>event</code> to confirm that it was changed. The spec expectation also looks for the <code>event.id</code> in the response, since that is what our iOS app will be expecting after a successful PATCH request.</p>
<pre><code># spec/requests/api/v1/events/events_spec.rb

describe 'PATCH /v1/events/:id' do
  it 'updates the event attributes' do
    event = create(:event, name: 'Old name')
    new_name = 'New name'

    patch "/v1/events/#{event.id}", {
      address: event.address,
      ended_at: event.ended_at,
      lat: event.lat,
      lon: event.lon,
      name: new_name,
      owner: {
        device_token: event.owner.device_token
      },
      started_at: event.started_at
    }.to_json, { 'Content-Type' =&gt; 'application/json' }

    event = Event.last
    expect(event.name).to eq new_name
    expect(response_json).to eq({ 'id' =&gt; event.id })
  end</code></pre>
<section id="controller-3" class="level4">
<h4>Controller</h4>
<p>When we run the test above, we will again get a routing error: <code>No route matches [PATCH] "/v1/events/13"</code> (note: your <code>id</code> will likely not be <code>13</code> like mine, but the error message should otherwise be the same).</p>
<p>Let's add the <code>update</code> route to fix that:</p>
<pre><code>#config/routes.rb

Humon::Application.routes.draw do
  scope module: :api, defaults: { format: 'json' } do
    namespace :v1 do
      resources :events, only: [:create, :show, :update]
    end
  end
end</code></pre>
<p>If we updated the <code>routes.rb</code> file correctly, running our test again should produce a different error: <code>The action 'update' could not be found for Api::V1::EventsController</code>.</p>
<p>What a nice, clear error message! Thank you, RSpec. Let's add that <code>update</code> method to our controller.</p>
<p>Note: Rails' scaffolding places the <code>update</code> method second to last in the controller, right above <code>destroy</code>. To stick with that convention, I will add the <code>update</code> method below my other controller methods, right above the <code>private</code> methods:</p>
<pre><code># app/controllers/api/v1/events_controller.rb

class Api::V1::EventsController &lt; ApiController

 ...

  def update
  end

  private

  ...

end</code></pre>
<p>Run the spec again, and, our error has changed to <code>Missing template api/v1/events/update</code>. Like we covered in the last section, receiving a different error message is a good indication that the last change we made is bringing us closer to a passing test.</p>
<p>We will address the view layer in the next section, but for now let's just create an empty file at <code>app/views/api/v1/event/update.json.jbuilder</code>.</p>
<p>Run the spec again, and our error has changed (woot!) to:</p>
<pre><code>Failure/Error: expect(event.name).to eq new_name

   expected: "New name" got: "Old name"</code></pre>
<p>See how handy the semantic variable naming in our test is?</p>
<p>Our route, controller method, and view template are in place. All that's left is to add logic to our <code>update</code> method that actually updates our <code>event</code>:</p>
<pre><code># app/controllers/api/v1/events_controller.rb

def update
  @event = Event.find(params[:id])

  if @event.update_attributes(event_params)
    render
  end
end</code></pre>
<p>If we run our request spec again, we will find that <code>event.name</code> is now updating correctly. Yay! But the test is still failing. Boo! Time to move onto our view.</p>
</section>
<section id="view-2" class="level4">
<h4>View</h4>
<p>Our spec error now looks like this (note: your expectation might have a different <code>id</code> number depending on how many time's you've run your test; that's fine):</p>
<pre><code> Failure/Error: expect(response_json).to eq({ 'id' =&gt; event.id })

   expected: {"id"=&gt;21} got: {}</code></pre>
<p>Our view template exists, but is rendering an empty JSON object. And of course it is, all we did was create an empty view template! Let's add the JSON our test is expecting:</p>
<pre><code># app/views/api/v1/events/update.json.jbuilder

json.id @event.id</code></pre>
<p>Our test passes!</p>
</section>
</section>
<section id="it-all-starts-with-a-request-spec-part-ii-1" class="level3">
<h3>It all starts with a request spec, part II</h3>
<p>If you guessed that our PATCH request requires two specs, you'd be right! One thing we've found when creating APIs with Rails is that it's just as important to return consistent, logical error messages and response codes as it is to create endpoints and responses for valid requests.</p>
<p>Like our POST request, a PATCH request has as "sad path" where the parameters passed are invalid. We need to create logic in our controller for that case, and to test drive that logic we will write a request spec:</p>
<pre><code># spec/requests/api/v1/events/events_spec.rb

describe 'PATCH /v1/events/:id' do

  ...

  it 'returns an error message when invalid' do
     event = create(:event)

    patch "/v1/events/#{event.id}", {
       address: event.address,
       ended_at: event.ended_at,
       lat: event.lat,
       lon: event.lon,
       name: nil,
       owner: {
         device_token: event.owner.device_token
       },
       started_at: event.started_at
     }.to_json, { 'Content-Type' =&gt; 'application/json' }

     event = Event.last
     expect(event.name).to_not be nil
     expect(response_json).to eq({
       'message' =&gt; 'Validation Failed',
       'errors' =&gt; [
         "Name can't be blank",
       ]
     })
     expect(response.code.to_i).to eq 422
   end
 end</code></pre>
<p>In our expectation above, we are hoping to see a <code>422</code> response, which is the <a href="http://www.bennadel.com/blog/2434-HTTP-Status-Codes-For-Invalid-Data-400-vs-422.htm">most appropriate</a> HTTP status code for a request with invalid (but not <a href="http://stackoverflow.com/a/20215807/1019369">malformed</a>) attributes.</p>
<p>The need for this test is apparent immediately upon running it: rather than returning a validation erorr or telling response code, we are getting the same response from a PATCH request with <em>invalid</em> parameters that we got from a PATCH request with <em>valid</em> parameters:</p>
<pre><code> Failure/Error: expect(response_json).to eq({

   expected: {"message"=&gt;"Validation Failed", "errors"=&gt;["Name can't be blank"]}
        got: {"id"=&gt;24}</code></pre>
<p>Our iOS app will have no way of knowing that a request with invalid parameters was passed, since it returns the same JSON either way.</p>
<p>To fix this, we will add a branching statement to our controller method that renders the <code>event</code> error messages (note: these error messages already exist because of the validations we set up in our <code>Event</code> model) and a <code>422</code> status:</p>
<pre><code># app/controllers/api/v1/events_controller.rb

class Api::V1::EventsController &lt; ApiController

  ...

  def update
    @event = Event.find(params[:id])

  if @event.update_attributes(event_params)
    render
  else
    render json: {
      message: 'Validation Failed',
      errors: @event.errors.full_messages
    }, status: 422
  end</code></pre>
<p>Phew! Our test passes.</p>
<p>Hooray! We've now successfully implemented 3 different HTTP requests in our Rails API. Don't forget to update the API documentation. Next we'll be having some fun with geocoding!</p>
</section>
</section></body>
</html>
