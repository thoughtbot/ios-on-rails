<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="thoughtbot" />
  <meta name="author" content="Jessie Young" />
  <meta name="author" content="Diana Zmuda" />
  <title>iOS on Rails (Beta): Creating a POST request</title>
  <style type="text/css"><![CDATA[code{white-space: pre;}]]></style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="data:text/css,%2A%20%7B%0A%20%20%2Dmoz%2Dbox%2Dsizing%3A%20border%2Dbox%3B%0A%20%20%2Dwebkit%2Dbox%2Dsizing%3A%20border%2Dbox%3B%0A%20%20box%2Dsizing%3A%20border%2Dbox%3B%20%7D%0A%0Abody%20%7B%0A%20%20font%2Dsize%3A%201em%3B%0A%20%20height%3A%20100%25%3B%0A%20%20margin%3A%200%20auto%3B%0A%20%20max%2Dwidth%3A%2054em%3B%0A%20%20padding%3A%200%201em%204%2E5em%3B%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20600px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%204em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20700px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20font%2Dsize%3A%201%2E125em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20800px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%206em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20880px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%208em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20940px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20padding%3A%200%2010em%204%2E5em%3B%20%7D%20%7D%0A%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%201800px%29%20%7B%0A%20%20%20%20body%20%7B%0A%20%20%20%20%20%20font%2Dsize%3A%201%2E375em%3B%20%7D%20%7D%0A%0Anav%20%7B%0A%20%20border%2Dbottom%3A%201px%20dashed%20%23dddddd%3B%0A%20%20border%2Dtop%3A%201px%20dashed%20%23dddddd%3B%0A%20%20padding%3A%201%2E5em%200%3B%0A%20%20margin%3A%201%2E5em%200%3B%20%7D%0A%20%20nav%20%3E%20ul%20%3E%20li%20%3E%20a%20%7B%0A%20%20%20%20font%2Dweight%3A%20bold%3B%20%7D%0A%0Aheader%20%7B%0A%20%20padding%3A%204%2E5em%200%3B%20%7D%0A%0Abody%20%7B%0A%20%20%2Dwebkit%2Dfont%2Dsmoothing%3A%20antialiased%3B%0A%20%20color%3A%20%23444444%3B%0A%20%20font%2Dfamily%3A%20%22proxima%2Dnova%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0A%20%20line%2Dheight%3A%201%2E5em%3B%20%7D%0A%0Ah1%2C%20h2%2C%20h3%2C%20h4%2C%20h5%2C%20h6%20%7B%0A%20%20color%3A%20%23222222%3B%0A%20%20font%2Dfamily%3A%20%22proxima%2Dnova%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0A%20%20line%2Dheight%3A%201%2E25em%3B%0A%20%20margin%3A%201%2E5em%200%200%2E375em%3B%0A%20%20text%2Drendering%3A%20optimizeLegibility%3B%20%7D%0A%20%20h1%20%3E%20a%2C%20h2%20%3E%20a%2C%20h3%20%3E%20a%2C%20h4%20%3E%20a%2C%20h5%20%3E%20a%2C%20h6%20%3E%20a%20%7B%0A%20%20%20%20color%3A%20%23222222%3B%20%7D%0A%0Ah1%20%7B%0A%20%20margin%3A%203em%200%200%2E375em%3B%0A%20%20font%2Dsize%3A%201%2E75em%3B%20%7D%0A%20%20h1%20%3E%20a%20%7B%0A%20%20%20%20color%3A%20%23c32f34%3B%20%7D%0A%20%20%20%20h1%20%3E%20a%3Ahover%2C%20h1%20%3E%20a%3Afocus%20%7B%0A%20%20%20%20%20%20color%3A%20%23222222%3B%20%7D%0A%20%20h1%2Etitle%20%7B%0A%20%20%20%20font%2Dsize%3A%203em%3B%0A%20%20%20%20font%2Dweight%3A%20900%3B%0A%20%20%20%20line%2Dheight%3A%201%3B%0A%20%20%20%20margin%3A%200%200%20%2E125em%3B%20%7D%0A%20%20%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20600px%29%20%7B%0A%20%20%20%20%20%20h1%2Etitle%20%7B%0A%20%20%20%20%20%20%20%20font%2Dsize%3A%204em%3B%20%7D%20%7D%0A%0Ah2%20%7B%0A%20%20font%2Dsize%3A%201em%3B%0A%20%20letter%2Dspacing%3A%201px%3B%0A%20%20text%2Dtransform%3A%20uppercase%3B%20%7D%0A%20%20h2%2Eauthor%20%7B%0A%20%20%20%20color%3A%20%23999999%3B%0A%20%20%20%20float%3A%20left%3B%0A%20%20%20%20font%2Dsize%3A%201em%3B%0A%20%20%20%20font%2Dweight%3A%20200%3B%0A%20%20%20%20margin%3A%200%3B%0A%20%20%20%20text%2Dtransform%3A%20none%3B%20%7D%0A%20%20%20%20%40media%20screen%20and%20%28min%2Dwidth%3A%20600px%29%20%7B%0A%20%20%20%20%20%20h2%2Eauthor%20%7B%0A%20%20%20%20%20%20%20%20font%2Dsize%3A%201%2E25em%3B%20%7D%20%7D%0A%20%20%20%20h2%2Eauthor%3Anot%28%3Alast%2Dchild%29%20%7B%0A%20%20%20%20%20%20margin%2Dright%3A%201em%3B%20%7D%0A%0Ah3%20%7B%0A%20%20font%2Dsize%3A%201em%3B%20%7D%0A%0Ah4%20%7B%0A%20%20font%2Dsize%3A%201%2E5em%3B%20%7D%0A%0Ah5%20%7B%0A%20%20font%2Dsize%3A%201%2E25em%3B%20%7D%0A%0Ah6%20%7B%0A%20%20font%2Dsize%3A%201em%3B%20%7D%0A%0Ap%20%7B%0A%20%20margin%3A%200%200%200%2E75em%3B%20%7D%0A%0Aa%20%7B%0A%20%20%2Dmoz%2Dtransition%3A%20all%200%2E15s%20ease%2Dout%200%3B%0A%20%20%2Dwebkit%2Dtransition%3A%20all%200%2E15s%20ease%2Dout%200%3B%0A%20%20color%3A%20%23477dca%3B%0A%20%20text%2Ddecoration%3A%20none%3B%0A%20%20transition%3A%20all%200%2E15s%20ease%2Dout%200%3B%20%7D%0A%20%20a%3Ahover%20%7B%0A%20%20%20%20color%3A%20%232c5999%3B%20%7D%0A%20%20a%3Aactive%2C%20a%3Afocus%20%7B%0A%20%20%20%20color%3A%20%232c5999%3B%0A%20%20%20%20outline%3A%20none%3B%20%7D%0A%0Ahr%20%7B%0A%20%20border%3A%20none%3B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23dddddd%3B%0A%20%20margin%3A%201%2E5em%200%3B%20%7D%0A%0Aimg%20%7B%0A%20%20margin%3A%200%3B%0A%20%20max%2Dwidth%3A%20100%25%3B%20%7D%0A%0Acode%20%7B%0A%20%20font%2Dfamily%3A%20inconsolata%2C%20%22Bitstream%20Vera%20Sans%20Mono%22%2C%20Consolas%2C%20Courier%2C%20monospace%3B%0A%20%20font%2Dsize%3A%20%2E875em%3B%0A%20%20white%2Dspace%3A%20pre%3B%0A%20%20word%2Dwrap%3A%20break%2Dword%3B%20%7D%0A%0Apre%20%7B%0A%20%20background%3A%20%23f7f7f7%3B%0A%20%20border%3A%201px%20solid%20%23dddddd%3B%0A%20%20line%2Dheight%3A%201%2E35%3B%0A%20%20overflow%2Dx%3A%20scroll%3B%0A%20%20padding%3A%20%2E5rem%201rem%3B%0A%20%20white%2Dspace%3A%20pre%3B%0A%20%20word%2Dwrap%3A%20normal%3B%20%7D%0A%20%20pre%20code%20%7B%0A%20%20%20%20word%2Dwrap%3A%20normal%3B%20%7D%0A%0Ablockquote%20%7B%0A%20%20border%2Dleft%3A%202px%20solid%20%23dddddd%3B%0A%20%20color%3A%20%236a6a6a%3B%0A%20%20margin%3A%201%2E5em%200%3B%0A%20%20padding%2Dleft%3A%200%2E75em%3B%20%7D%0A" rel="stylesheet" />
  <script type="text/javascript"><![CDATA[
    (function() {
      var config = {
        kitId: 'bgd6ksj',
        scriptTimeout: 3000
      };
      var h=document.getElementsByTagName("html")[0];h.className+=" wf-loading";var t=setTimeout(function(){h.className=h.className.replace(/(\s|^)wf-loading(\s|$)/g," ");h.className+=" wf-inactive"},config.scriptTimeout);var tk=document.createElement("script"),d=false;tk.src='//use.typekit.net/'+config.kitId+'.js';tk.type="text/javascript";tk.async="true";tk.onload=tk.onreadystatechange=function(){var a=this.readyState;if(d||a&&a!="complete"&&a!="loaded")return;d=true;clearTimeout(t);try{Typekit.load(config)}catch(b){}};var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(tk,s)
    })();
  ]]></script>
</head>
<body><section id="creating-a-post-request" class="level1">
<h1>Creating a POST request</h1>
<section id="forgery-protection-strategy-and-rails-4" class="level3">
<h3>Forgery protection strategy and Rails 4</h3>
<p>Before we begin digging into creating POST requests to our API, we need to change our forgery protection strategy.</p>
<p>Rails protects against <a href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">cross-site request forgery</a> by protecting your application from requests that are missing authenticity tokens. <a href="http://stackoverflow.com/a/1571900/1019369">An explanation</a> of authenticity tokens in Rails:</p>
<blockquote>
<p>When the user views a form to create, update, or destroy a resource, the Rails app would create a random <code>authenticity_token</code>, store this token in the session, and place it in a hidden field in the form. When the user submits the form, Rails would look for the <code>authenticity_token</code>, compare it to the one stored in the session, and if they match the request is allowed to continue.</p>
</blockquote>
<p>Why this happens:</p>
<blockquote>
<p>Since the authenticity token is stored in the session, the client can not know its value. This prevents people from submitting forms to a Rails app without viewing the form within that app itself. Imagine that you are using service A, you logged into the service and everything is ok. Now imagine that you went to use service B, and you saw a picture you like, and pressed on the picture to view a larger size of it. Now, if some evil code was there at service B, it might send a request to service A (which you are logged into), and ask to delete your account, by sending a request to <code>http://serviceA.com/close_account</code>. This is what is known as CSRF (Cross Site Request Forgery).</p>
</blockquote>
<p>While protecting against CSRF attacks is a good thing, the default forgery protection strategy in Rails 4 is problematic for dealing with POST requests to APIs. If you make a POST request to a Rails endpoint (rather than using a standard web form to create a record), you will see the following error:</p>
<pre><code>ActionController::InvalidAuthenticityToken</code></pre>
<p>Rails lets us choose between forgery protection strategies. The default in Rails 4 is <code>:exception</code>, which we are seeing in action above. Rails recommends the <code>:null_session</code> strategy for APIs, which empties the session rather than raising an exception. Since we want this strategy for all API endpoints but not necessarily all endpoints, we will create an <code>ApiController</code> that all of our API controllers will inherit from and set the forgery protection strategy there:</p>
<pre><code># app/controllers/api_controller.rb

class ApiController &lt; ApplicationController
  protect_from_forgery with: :null_session
end

# app/controllers/api/v1/events_controller.rb

class Api::V1::EventsController &lt; ApiController

...

end</code></pre>
<p>Now we're ready to get started on our first POST request.</p>
</section>
<section id="it-all-starts-with-a-request-spec-1" class="level3">
<h3>It all starts with a request spec</h3>
<p>We will start working on our POST request the same way we began working on our GET request: with a request spec.</p>
<pre><code># spec/requests/api/v1/events/events_spec.rb

describe 'POST /v1/events' do
  it 'saves the address, lat, lon, name, and started_at date' do
    date = Time.zone.now
    device_token = '123abcd456xyz'
    owner = create(:user, device_token: device_token)

    post '/v1/events', {
      address: '123 Example St.',
      ended_at: date,
      lat: 1.0,
      lon: 1.0,
      name: 'Fun Place!!',
      started_at: date,
      owner: {
        device_token: device_token
      }
    }.to_json, { 'Content-Type' =&gt; 'application/json' }

    event = Event.last
    expect(response_json).to eq({ 'id' =&gt; event.id })
    expect(event.address).to eq '123 Example St.'
    expect(event.ended_at.to_i).to eq date.to_i
    expect(event.lat).to eq 1.0
    expect(event.lon).to eq 1.0
    expect(event.name).to eq 'Fun Place!!'
    expect(event.started_at.to_i).to eq date.to_i
    expect(event.owner).to eq owner
  end
end</code></pre>
<p>Note about the time comparisons above: the reason we are calling <code>to_i</code> on <code>event.started_at</code> and <code>event.ended_at</code> is that Ruby time (the time we are setting when we declare the <code>date</code> variable) is more precise than ActiveRecord time (the time we are getting back from <code>Event.last</code>). If you run the tests without <code>to_i</code>, you will see something like this:</p>
<pre><code>    expected: Wed, 16 Apr 2014 17:13:47 UTC +00:00
         got: Wed, 16 Apr 2014 17:13:47 UTC +00:00</code></pre>
<p>Even though the date objects themselves appear equal, as <a href="http://blog.tddium.com/2011/08/07/rails-time-comparisons-devil-details-etc/">this blog post on time comparisons in Rails notes</a>, "When the value is read back from the database, it's only preserved to microsecond precision, while the in-memory representation is precise to nanoseconds." Calling <code>to_i</code> on these dates normalizes them to use the same place value, which renders them equal for our test.</p>
<section id="controller-1" class="level4">
<h4>Controller</h4>
<p>When we run the test above, our first error should be <code>No route matches [POST] "/v1/events"</code>. This is exactly the error we would expect, since we haven't defined this route in our <code>routes.rb</code> file. Let's fix that:</p>
<pre><code>#config/routes.rb

Humon::Application.routes.draw do
  scope module: :api, defaults: { format: 'json' } do
    namespace :v1 do
      resources :events, only: [:create, :show]
    end
  end
end</code></pre>
<p>When we run the spec again, our error has changed to</p>
<pre><code>The action 'create' could not be found for Api::V1::EventsController</code></pre>
<p>This is good; it means the route we added is working, but we still need to add a <code>create</code> method to our <code>EventsController</code>. So let's do that:</p>
<pre><code># app/controllers/api/v1/events_controller.rb

class Api::V1::EventsController &lt; ApiController
  def create
  end

  ...

end</code></pre>
<p>Run the spec again, and our error has changed to <code>Missing template api/v1/events/create</code>. Again, receiving a different error message is a good indication that the last change we made is bringing us closer to a passing test.</p>
<p>We will get back to the view layer in the next section, but for now let's just create an empty file at <code>app/views/api/v1/events/create.json.jbuilder</code>, since that will help us get to our next error.</p>
<p>Run the spec again, and our error has changed (hooray!) to:</p>
<pre><code> Failure/Error: expect(response_json).to eq({ 'id' =&gt; event.id })
   NoMethodError:
     undefined method `id' for nil:NilClass</code></pre>
<p>If we look back at our spec, we can see that <code>id</code> is being called on <code>event</code>, which is the variable name we assigned to <code>Event.last</code>. By saying that <code>id</code> is an undefined method for <code>nil</code>, our error is telling us that <code>Event.last</code> is <code>nil</code>.</p>
<p>And of course it is! We haven't added any logic into our controller that would create an instance of <code>Event</code>; at the moment, all we have is an empty <code>create</code> method. Time to add some logic:</p>
<pre><code># app/controllers/api/v1/events_controller.rb

class Api::V1::EventsController &lt; ApiController
  def create
    @event = Event.new(event_params)

    if @event.save
      render
    end
  end

  ...

  private

  def event_params
    {
      address: params[:address],
      ended_at: params[:ended_at],
      lat: params[:lat],
      lon: params[:lon],
      name: params[:name],
      started_at: params[:started_at],
      owner: user
    }
  end

  def user
    User.find_or_create_by(device_token: device_token)
  end

  def device_token
    params[:owner].try(:[], :device_token)
  end
end</code></pre>
<p>Our error message has changed yet again, and now it is time for us to move to the final step: creating our view.</p>
</section>
<section id="view-1" class="level4">
<h4>View</h4>
<p>Our <a href="https://github.com/thoughtbot/ios-on-rails/blob/master/example_apps/rails/app/controllers/api/v1/events_controller.rb"><code>EventsController</code></a> is creating an <code>event</code>, but we are still getting an error when we run our spec (note: your expectation might have a different <code>id</code> number depending on how many time's you've run your test; that's fine):</p>
<pre><code>expect(response_json).to eq({ 'id' =&gt; event.id })
       expected: {"id"=&gt;6}
        got: {}</code></pre>
<p>The empty brackets we are getting tell us that our view is rendering an empty JSON object. Time to fix our empty view template:</p>
<pre><code># app/views/api/v1/events/create.json.jbuilder

json.id @event.id</code></pre>
<p>And with that, our test is passing. Nice work. But before we move on, let's not forget our second POST spec.</p>
</section>
</section>
<section id="it-all-starts-with-a-request-spec-part-ii" class="level3">
<h3>It all starts with a request spec, part II</h3>
<p>Our first spec covered the "happy path," which <a href="http://en.wikipedia.org/wiki/Happy_path">Wikipedia</a> defines as the "a well-defined test case using known input, which executes without exception and produces an expected output." Our second test will show the "sad path," which means that it will cover validation and error handling.</p>
<p>You might remember that our GET request section only contained a single test. While these decisions are rarely black and white, it was our judgment that only a "happy path" test was required for that endpoint. The "sad path" for a GET request would occur when the <code>id</code> in the URL does not correspond to an existing <code>event</code>. In that case, the application would return a <a href="http://en.wikipedia.org/wiki/HTTP_404"><code>404 Not Found</code></a> response code, which is the default behavior and therefore does not need to be tested.</p>
<p>By default, passing invalid attributes to our POST request would not create the <code>event</code> and would return a response body without helpful error messages and a misleading response code of <a href="http://en.wikipedia.org/wiki/HTTP_2002xx_Success.html"><code>200 OK</code></a>.</p>
<p>Because we want to change both the response body and the response code returned when invalid attributes are used in a POST request, writing a test for that scenario makes sense.</p>
<p>Let's move on to our "sad path" request spec and cover a POST request with invalid attributes (it will go inside the same <code>describe</code> block as our first POST request spec):</p>
<pre><code># spec/requests/api/v1/events/events_spec.rb

describe 'POST /v1/events' do

...

 it 'returns an error message when invalid' do
    post '/v1/events',
      {}.to_json,
      { 'Content-Type' =&gt; 'application/json' }

    expect(response_json).to eq({
      'message' =&gt; 'Validation Failed',
      'errors' =&gt; [
        "Lat can't be blank",
        "Lon can't be blank",
        "Name can't be blank",
        "Started at can't be blank",
      ]
    })
    expect(response.code.to_i).to eq 422
  end
end</code></pre>
<p>Creating an <code>event</code> without attributes does not work because of the validations we set up in the GET request section of this book. If you need a refresher, check out the validations on <a href="https://github.com/thoughtbot/ios-on-rails/blob/master/example_apps/rails/app/models/event.rb"><code>Event</code></a>.</p>
<p>Right now, rather than our response JSON containing the message and errors we want to see, we get <code>{"id"=&gt;nil}</code>. Time to look at the <code>EventsController</code>.</p>
<section id="controller-2" class="level5">
<h5>Controller</h5>
<p>Right now, our controller doesn't contain any instructions for what to do in the case that an <code>event</code> does not save properly, which is why we do not see the message or errors included in our spec. So let's add those:</p>
<pre><code># app/controllers/api/v1/events_controller.rb

class Api::V1::EventsController &lt; ApiController
  def create
    @event = Event.new(event_params)

    if @event.save
      render
    else
      render json: {
        message: 'Validation Failed',
        errors: @event.errors.full_messages
      }, status: 422
    end
  end

  ...

end</code></pre>
<p>With this change, our spec should be passing.</p>
<p>To manually test that this is working, make sure you are running <code>rails server</code> and try a <code>curl</code> request in another Terminal window:</p>
<pre><code>$ curl --data "{}" http://localhost:3000/v1/events</code></pre>
<p>You should see the same message and errors that are in the "sad path" spec expectations.</p>
<p>With that, our second request spec is passing. Nice work!</p>
</section>
</section>
</section></body>
</html>
